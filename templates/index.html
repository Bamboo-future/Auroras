<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小说内容分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .container { max-width: 1200px; }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            background-color: #f8f9fa;
        }
        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 15px;
        }
        .results-section { margin-top: 30px; display: none; }
        .card {
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.8rem;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        .main-character {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 15px;
            padding: 8px 15px;
            margin: 5px;
            display: inline-block;
            font-weight: bold;
        }
        .supporting-character {
            background: #e9ecef;
            color: #495057;
            border-radius: 10px;
            padding: 5px 10px;
            margin: 3px;
            display: inline-block;
            font-size: 0.9rem;
        }
        .relationship-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #0d6efd;
        }
        .chapter-card {
            border-left: 3px solid #0d6efd;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        .plot-stage-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
        }
        .stage-beginning { background-color: #00b894; color: white; }
        .stage-development { background-color: #0984e3; color: white; }
        .stage-climax { background-color: #e17055; color: white; }
        .stage-ending { background-color: #6c5ce7; color: white; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="text-center mb-4">
            <h1 class="display-6 fw-bold text-primary">
                <i class="fas fa-book-open me-2"></i>小说内容分析系统
            </h1>
            <p class="text-muted">上传Word文档，深度分析词频、人物关系和情节发展</p>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
                <i class="fas fa-file-upload"></i>
            </div>
            <h5 class="mb-3">上传Word格式的小说文档</h5>
            <p class="text-muted mb-3">支持 .docx 格式 | 最大 16MB</p>

            <form method="POST" action="/upload" enctype="multipart/form-data" id="uploadForm">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input class="form-control" type="file" name="file" accept=".docx" required id="fileInput">
                            <button type="submit" class="btn btn-primary" id="analyzeBtn">
                                <i class="fas fa-chart-bar me-2"></i>开始分析
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">分析中...</span>
            </div>
            <p class="mt-2">正在分析文档，请稍候...</p>
        </div>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {% for message in messages %}
                        <div><i class="fas fa-exclamation-triangle me-2"></i>{{ message }}</div>
                    {% endfor %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}
        {% endwith %}

        <div class="results-section" id="resultsSection">
            {% if text_preview %}
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-line me-2"></i>分析结果 - {{ filename }}
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">{{ total_words }}</div>
                                <div class="stat-label">总词数</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">{{ unique_words }}</div>
                                <div class="stat-label">唯一词汇</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">{{ text_length }}</div>
                                <div class="stat-label">字符数</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">{{ reading_time }}</div>
                                <div class="stat-label">阅读时间(分钟)</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>文本预览 ({{ preview_percentage }}%):</strong>
                        <div class="mt-2 p-3 bg-light rounded" style="max-height: 200px; overflow-y: auto;">
                            {{ text_preview }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-bar me-2"></i>高频词汇 TOP 20
                        </div>
                        <div class="card-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>排名</th>
                                            <th>词语</th>
                                            <th>次数</th>
                                            <th>占比</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for word, count, percentage in word_freq[:20] %}
                                        <tr>
                                            <td class="fw-bold">#{{ loop.index }}</td>
                                            <td><span class="badge bg-secondary">{{ word }}</span></td>
                                            <td>{{ count }}</td>
                                            <td><small>{{ "%.2f"|format(percentage) }}%</small></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-image me-2"></i>词频统计图
                        </div>
                        <div class="card-body text-center">
                            {% if word_chart %}
                                <img src="{{ word_chart }}" alt="词频统计图" class="img-fluid">
                            {% else %}
                                <p class="text-muted">无法生成图表</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-users me-2"></i>人物分析
                        </div>
                        <div class="card-body">
                            <h6 class="mb-3"><i class="fas fa-crown text-warning me-2"></i>主要人物</h6>
                            <div class="mb-4">
                                {% for char, score, count in characters_data.main_characters %}
                                <div class="main-character">
                                    {{ char }} <small>({{ count }}次)</small>
                                </div>
                                {% endfor %}
                            </div>

                            <h6 class="mb-3"><i class="fas fa-user-friends text-info me-2"></i>次要人物</h6>
                            <div>
                                {% for char, score, count in characters_data.supporting_characters %}
                                <div class="supporting-character">
                                    {{ char }} <small>({{ count }})</small>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-project-diagram me-2"></i>人物关系网络
                        </div>
                        <div class="card-body text-center">
                            {% if relationship_chart %}
                                <img src="{{ relationship_chart }}" alt="人物关系网络图" class="img-fluid">
                            {% else %}
                                <p class="text-muted">无法生成关系网络图</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-list me-2"></i>关系明细
                        </div>
                        <div class="card-body">
                            <div style="max-height: 400px; overflow-y: auto;">
                                {% for relation in relationships %}
                                <div class="relationship-item">
                                    <div class="d-flex justify-content-between">
                                        <span>
                                            <strong>{{ relation.source }}</strong> -
                                            <strong>{{ relation.target }}</strong>
                                        </span>
                                        <span class="badge bg-primary">{{ relation.type }}</span>
                                    </div>
                                    <small class="text-muted">强度: {{ relation.strength }}</small>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-road me-2"></i>情节发展分析
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for chapter in plot_development %}
                                <div class="col-12 mb-3">
                                    <div class="card chapter-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title mb-0">{{ chapter.title }}</h6>
                                                <span class="plot-stage-badge {{ 'stage-' + chapter.stage }}">
                                                    {{ chapter.stage }}
                                                </span>
                                            </div>

                                            <div class="mb-2">
                                                {% for function in chapter.plot_function %}
                                                <span class="badge bg-info me-1">{{ function }}</span>
                                                {% endfor %}
                                            </div>

                                            {% for activity in chapter.character_analysis %}
                                            <div class="small mb-2">
                                                <strong>{{ activity.character }}</strong>:
                                                {{ activity.time }}在{{ activity.location }}{{ activity.action }}，
                                                心理状态:
                                                <span class="{% if activity.psychological_state == '积极' %}text-success{% elif activity.psychological_state == '消极' %}text-danger{% else %}text-muted{% endif %}">
                                                    {{ activity.psychological_state }}
                                                </span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line me-2"></i>情节情感发展
                        </div>
                        <div class="card-body text-center">
                            {% if plot_chart %}
                                <img src="{{ plot_chart }}" alt="情节发展图" class="img-fluid">
                            {% else %}
                                <p class="text-muted">无法生成情节发展图</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button class="btn btn-outline-primary" onclick="resetAnalysis()">
                    <i class="fas fa-redo me-1"></i>分析新文档
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('uploadForm').addEventListener('submit', function() {
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'block';
        });

        function resetAnalysis() {
            window.location.href = '/';
        }

        {% if text_preview %}
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('uploadArea').style.display = 'none';
        {% endif %}
    </script>
</body>
</html>